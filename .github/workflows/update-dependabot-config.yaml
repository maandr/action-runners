name: "ü§ñ Generate Dependabot Config"

on:
  pull_request:
    branches: [ main ]
    paths:
      - "**/Dockerfile"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-generate-dependabot-config
  cancel-in-progress: true

env:
  DEPENDABOT_FILE: ".github/dependabot.yaml"
  SCHEDULE: "weekly"

jobs:
  generate-dependabot-config:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: "‚è¨ Checkout Git Repository"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: "üìù Generate dependabot config"
        run: |
          i=0
          
          echo "# THIS FILE IS GENERATED BY THE update-dependabot-config WORKFLOW" > $DEPENDABOT_FILE
          echo "version: 2" >> $DEPENDABOT_FILE
            yq -i "
              .updates[$i].package-ecosystem = \"github-actions\" |
              .updates[$i].directory = \"/\" |
              .updates[$i].schedule.interval = \"$SCHEDULE\"
            " $DEPENDABOT_FILE
          ((i++))
          
          for file in $(find . -type f -name Dockerfile); do
            dir=$(dirname "$file")
            yq -i "
              .updates[$i].package-ecosystem = \"docker\" |
              .updates[$i].directory = \"$dir\" |
              .updates[$i].schedule.interval = \"$SCHEDULE\"
            " $DEPENDABOT_FILE
            ((i++))
          done

      - name: "‚è´ Commit and push changes"
        uses: maandr/github-actions/git/commit-and-push@v3
        with:
          commit_message: "chore: generate dependabot config"
          commit_user_name: ${{ github.actor }}
          push_options: "--force"
